name: Update Website Config

on:
  repository_dispatch:
    types: [update_config]
  workflow_dispatch:
    inputs:
      config:
        description: 'Base64 encoded config content'
        required: false
        type: string

jobs:
  update-config:
    runs-on: ubuntu-latest
    
    # è®¾ç½®çŽ¯å¢ƒå˜é‡
    env:
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      REPOSITORY_NAME: ${{ secrets.REPOSITORY_NAME }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        
    - name: Update website configuration
      run: |
        # èŽ·å–é…ç½®å†…å®¹
        if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
          CONFIG_CONTENT="${{ github.event.client_payload.config }}"
        else
          CONFIG_CONTENT="${{ inputs.config }}"
        fi
        
        # æ›´æ–°é…ç½®æ–‡ä»¶
        if [ ! -z "$CONFIG_CONTENT" ]; then
          echo "ðŸ“ Updating websiteData.js..."
          echo "$CONFIG_CONTENT" | base64 -d > src/websiteData.js
          
          # éªŒè¯æ–‡ä»¶æ ¼å¼
          if node -c src/websiteData.js; then
            echo "âœ… Configuration updated successfully!"
          else
            echo "âŒ Invalid JavaScript syntax in websiteData.js"
            exit 1
          fi
        else
          echo "âš ï¸  No configuration provided, skipping update..."
          exit 0
        fi
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if ! git diff --quiet src/websiteData.js; then
          git add src/websiteData.js
          git commit -m "ðŸ”§ Auto-update website config via admin panel"
          git push origin main
          echo "âœ… Configuration committed and pushed"
        else
          echo "â„¹ï¸  No changes detected"
        fi
        
    - name: Create summary
      run: |
        echo "## ðŸš€ é…ç½®æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ›´æ–°æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **è‡ªåŠ¨éƒ¨ç½²**: EdgeOne Pageså°†è‡ªåŠ¨æ£€æµ‹å˜æ›´å¹¶é‡æ–°éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ ç½‘ç«™é…ç½®å·²æ›´æ–°ï¼ŒEdgeOne Pagesæ­£åœ¨è‡ªåŠ¨éƒ¨ç½²æ–°ç‰ˆæœ¬ï¼" >> $GITHUB_STEP_SUMMARY 