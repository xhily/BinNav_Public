<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åç«¯ä¸‹è½½å›¾æ ‡æµ‹è¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #fafafa;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #007cba; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-size: 14px;
        }
        button:hover { background: #005a87; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffe8e8; border-color: #f44336; }
        .warning { background: #fff3cd; border-color: #ff9800; }
        .info { background: #e3f2fd; border-color: #2196f3; }
        input { 
            padding: 8px; 
            margin: 5px; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            width: 300px;
            font-size: 14px;
        }
        pre { 
            background: #f5f5f5; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
            font-size: 12px;
            white-space: pre-wrap;
        }
        .icon-preview {
            display: inline-block;
            margin: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            background: white;
        }
        .icon-preview img {
            width: 32px;
            height: 32px;
            display: block;
            margin: 0 auto 5px;
            border: 1px solid #eee;
        }
        .icon-preview .label {
            font-size: 12px;
            color: #666;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #2196f3;
            background: #f8f9fa;
        }
        .step.completed {
            border-left-color: #4caf50;
            background: #f1f8e9;
        }
        .step.failed {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 13px;
        }
        .log-info { background: #e3f2fd; }
        .log-success { background: #e8f5e8; }
        .log-error { background: #ffebee; }
        .log-warning { background: #fff3cd; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ åç«¯ä¸‹è½½å›¾æ ‡æµ‹è¯•</h1>
        <p>æµ‹è¯•EdgeOne Functionsä»å¤–ç½‘URLä¸‹è½½å›¾æ ‡å¹¶ä¿å­˜åˆ°GitHubçš„åŠŸèƒ½</p>
        
        <div class="section">
            <h3>1. æµ‹è¯•å‚æ•°</h3>
            <div>
                <label>åŸŸå:</label>
                <input type="text" id="domain" placeholder="å¦‚: github.com" value="github.com">
            </div>
            <div>
                <label>å›¾æ ‡URL:</label>
                <input type="text" id="iconUrl" placeholder="å›¾æ ‡çš„å®Œæ•´URL" value="https://www.google.com/s2/favicons?domain=github.com&sz=32">
            </div>
            <button onclick="testDownload()" id="testBtn">å¼€å§‹æµ‹è¯•åç«¯ä¸‹è½½</button>
            <button onclick="testAPI()">æµ‹è¯•APIè¿é€šæ€§</button>
            <button onclick="testNetworkAccess()">æµ‹è¯•ç½‘ç»œè®¿é—®</button>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="section">
            <h3>2. æµ‹è¯•æ­¥éª¤</h3>
            <div id="steps">
                <div class="step" id="step1">
                    <strong>æ­¥éª¤1:</strong> éªŒè¯å›¾æ ‡URLå¯è®¿é—®æ€§
                    <div id="step1-detail"></div>
                </div>
                <div class="step" id="step2">
                    <strong>æ­¥éª¤2:</strong> è°ƒç”¨åç«¯ä¸‹è½½API
                    <div id="step2-detail"></div>
                </div>
                <div class="step" id="step3">
                    <strong>æ­¥éª¤3:</strong> éªŒè¯ä¸‹è½½ç»“æœ
                    <div id="step3-detail"></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>3. å›¾æ ‡é¢„è§ˆ</h3>
            <div id="icon-preview">
                <p>ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹...</p>
            </div>
        </div>
        
        <div class="section">
            <h3>4. è¯¦ç»†æ—¥å¿—</h3>
            <div id="log"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateStep(stepNum, status, detail = '') {
            const step = document.getElementById(`step${stepNum}`);
            const detailDiv = document.getElementById(`step${stepNum}-detail`);
            
            step.className = `step ${status}`;
            if (detail) {
                detailDiv.innerHTML = detail;
            }
        }

        async function testNetworkAccess() {
            log('æµ‹è¯•EdgeOne Functionsç½‘ç»œè®¿é—®èƒ½åŠ›', 'info');

            const iconUrl = document.getElementById('iconUrl').value.trim() || 'https://www.google.com/s2/favicons?domain=github.com&sz=32';

            try {
                const response = await fetch('/api/test-network', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        testUrl: iconUrl
                    })
                });

                log(`ç½‘ç»œæµ‹è¯•APIå“åº”çŠ¶æ€: ${response.status}`, 'info');

                if (response.ok) {
                    const result = await response.json();
                    log(`ç½‘ç»œæµ‹è¯•ç»“æœ: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');

                    if (result.success) {
                        log(`âœ… EdgeOne Functionså¯ä»¥è®¿é—®å¤–ç½‘`, 'success');
                        log(`ğŸ“Š å“åº”çŠ¶æ€: ${result.result.status}`, 'info');
                        log(`ğŸ“¦ æ•°æ®å¤§å°: ${result.result.responseSize} bytes`, 'info');
                        log(`â±ï¸ è€—æ—¶: ${result.result.duration}ms`, 'info');
                    } else {
                        log(`âŒ ç½‘ç»œè®¿é—®å¤±è´¥: ${result.error}`, 'error');
                        log(`ğŸ” å¯èƒ½åŸå› : ${result.possibleCauses?.join(', ')}`, 'warning');
                    }
                } else {
                    const errorText = await response.text();
                    log(`ç½‘ç»œæµ‹è¯•APIé”™è¯¯: ${errorText}`, 'error');
                }

            } catch (error) {
                log(`âŒ ç½‘ç»œæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testAPI() {
            log('æµ‹è¯•upload-icon APIè¿é€šæ€§', 'info');

            try {
                // æµ‹è¯•OPTIONSè¯·æ±‚
                const optionsResponse = await fetch('/api/upload-icon', {
                    method: 'OPTIONS'
                });

                log(`OPTIONSå“åº”çŠ¶æ€: ${optionsResponse.status}`, optionsResponse.ok || optionsResponse.status === 204 ? 'success' : 'error');

                if (optionsResponse.ok || optionsResponse.status === 204) {
                    log('âœ… upload-icon API OPTIONSè¯·æ±‚æ­£å¸¸', 'success');

                    // æµ‹è¯•POSTè¯·æ±‚ï¼ˆå‘é€æ— æ•ˆæ•°æ®çœ‹é”™è¯¯å“åº”ï¼‰
                    try {
                        const postResponse = await fetch('/api/upload-icon', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                test: 'connectivity'
                            })
                        });

                        log(`POSTæµ‹è¯•å“åº”çŠ¶æ€: ${postResponse.status}`, 'info');

                        if (postResponse.ok) {
                            const result = await postResponse.json();
                            log(`POSTå“åº”: ${JSON.stringify(result)}`, 'info');
                        } else {
                            const errorText = await postResponse.text();
                            log(`POSTé”™è¯¯å“åº”: ${errorText}`, 'warning');
                        }

                        log('âœ… upload-icon API POSTè·¯ç”±å­˜åœ¨', 'success');

                    } catch (postError) {
                        log(`âŒ POSTè¯·æ±‚å¤±è´¥: ${postError.message}`, 'error');
                    }
                } else {
                    log('âŒ upload-icon API OPTIONSè¯·æ±‚å¤±è´¥', 'error');
                }

            } catch (error) {
                log(`âŒ APIè¿é€šæ€§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('icon-preview').innerHTML = '<p>ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹...</p>';
            
            // é‡ç½®æ­¥éª¤çŠ¶æ€
            for (let i = 1; i <= 3; i++) {
                updateStep(i, '', '');
            }
        }

        async function testDownload() {
            const domain = document.getElementById('domain').value.trim();
            const iconUrl = document.getElementById('iconUrl').value.trim();
            const testBtn = document.getElementById('testBtn');
            
            if (!domain || !iconUrl) {
                log('è¯·å¡«å†™åŸŸåå’Œå›¾æ ‡URL', 'error');
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = 'æµ‹è¯•ä¸­...';
            clearLog();
            
            log(`å¼€å§‹æµ‹è¯•åç«¯ä¸‹è½½: ${domain}`, 'info');
            log(`å›¾æ ‡URL: ${iconUrl}`, 'info');
            
            try {
                // æ­¥éª¤1: éªŒè¯å›¾æ ‡URLå¯è®¿é—®æ€§
                log('æ­¥éª¤1: éªŒè¯å›¾æ ‡URLå¯è®¿é—®æ€§', 'info');
                updateStep(1, '', 'æ­£åœ¨éªŒè¯...');
                
                try {
                    const img = new Image();
                    img.crossOrigin = 'anonymous';
                    
                    const imageTest = new Promise((resolve, reject) => {
                        img.onload = () => {
                            log(`å›¾æ ‡å¯è®¿é—®ï¼Œå°ºå¯¸: ${img.width}x${img.height}`, 'success');
                            updateStep(1, 'completed', `âœ… å›¾æ ‡å¯è®¿é—® (${img.width}x${img.height})`);
                            resolve();
                        };
                        img.onerror = () => {
                            log('å›¾æ ‡URLæ— æ³•è®¿é—®æˆ–æœ‰CORSé™åˆ¶', 'warning');
                            updateStep(1, 'failed', 'âš ï¸ å›¾æ ‡URLè®¿é—®å—é™ï¼Œä½†åç«¯å¯èƒ½ä»èƒ½ä¸‹è½½');
                            resolve(); // ç»§ç»­æµ‹è¯•ï¼Œå› ä¸ºåç«¯å¯èƒ½èƒ½è®¿é—®
                        };
                        img.src = iconUrl;
                    });
                    
                    await imageTest;
                } catch (error) {
                    log(`å›¾æ ‡éªŒè¯å¤±è´¥: ${error.message}`, 'warning');
                    updateStep(1, 'failed', `âš ï¸ ${error.message}`);
                }
                
                // æ­¥éª¤2: è°ƒç”¨åç«¯ä¸‹è½½API
                log('æ­¥éª¤2: è°ƒç”¨åç«¯ä¸‹è½½API', 'info');
                updateStep(2, '', 'æ­£åœ¨è°ƒç”¨API...');
                
                const response = await fetch('/api/upload-icon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        domain: domain,
                        iconUrl: iconUrl
                    })
                });
                
                log(`APIå“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                log(`APIå“åº”: ${JSON.stringify(result, null, 2)}`, result.success ? 'success' : 'error');
                
                if (result.success) {
                    updateStep(2, 'completed', `âœ… ä¸‹è½½æˆåŠŸï¼Œæ–‡ä»¶: ${result.fileName}`);
                    
                    // æ­¥éª¤3: éªŒè¯ä¸‹è½½ç»“æœ
                    log('æ­¥éª¤3: éªŒè¯ä¸‹è½½ç»“æœ', 'info');
                    updateStep(3, '', 'æ­£åœ¨éªŒè¯ä¸‹è½½çš„å›¾æ ‡...');
                    
                    // æ˜¾ç¤ºå›¾æ ‡é¢„è§ˆ
                    const previewDiv = document.getElementById('icon-preview');
                    previewDiv.innerHTML = `
                        <div class="icon-preview">
                            <img src="${iconUrl}" alt="åŸå§‹å›¾æ ‡" onerror="this.style.border='2px solid red'">
                            <div class="label">åŸå§‹å›¾æ ‡</div>
                        </div>
                        <div class="icon-preview">
                            <img src="${result.staticPath}" alt="ç¼“å­˜å›¾æ ‡" onerror="this.style.border='2px solid red'">
                            <div class="label">ç¼“å­˜å›¾æ ‡</div>
                        </div>
                    `;
                    
                    // æµ‹è¯•ç¼“å­˜å›¾æ ‡æ˜¯å¦å¯è®¿é—®
                    const cachedImg = new Image();
                    cachedImg.onload = () => {
                        log('ç¼“å­˜å›¾æ ‡éªŒè¯æˆåŠŸ', 'success');
                        updateStep(3, 'completed', `âœ… ç¼“å­˜å›¾æ ‡å¯æ­£å¸¸è®¿é—®: ${result.staticPath}`);
                    };
                    cachedImg.onerror = () => {
                        log('ç¼“å­˜å›¾æ ‡è®¿é—®å¤±è´¥ï¼Œå¯èƒ½éœ€è¦ç­‰å¾…GitHub Pagesæ›´æ–°', 'warning');
                        updateStep(3, 'failed', 'âš ï¸ ç¼“å­˜å›¾æ ‡æš‚æ—¶æ— æ³•è®¿é—®ï¼Œè¯·ç¨åå†è¯•');
                    };
                    cachedImg.src = result.staticPath;
                    
                    log(`âœ… åç«¯ä¸‹è½½æµ‹è¯•æˆåŠŸï¼`, 'success');
                    log(`ğŸ“ æ–‡ä»¶è·¯å¾„: ${result.staticPath}`, 'info');
                    log(`ğŸ“Š æ–‡ä»¶å¤§å°: ${result.size} bytes`, 'info');
                    log(`ğŸ”— GitHubæäº¤: ${result.commit?.url}`, 'info');
                    
                } else {
                    updateStep(2, 'failed', `âŒ ${result.message || 'ä¸‹è½½å¤±è´¥'}`);
                    throw new Error(result.message || 'ä¸‹è½½å¤±è´¥');
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                if (!document.getElementById('step2').classList.contains('completed')) {
                    updateStep(2, 'failed', `âŒ ${error.message}`);
                }
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'å¼€å§‹æµ‹è¯•åç«¯ä¸‹è½½';
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶çš„è¯´æ˜
        window.onload = function() {
            log('åç«¯ä¸‹è½½å›¾æ ‡æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            log('æ­¤æµ‹è¯•å°†éªŒè¯EdgeOne Functionsä»å¤–ç½‘URLä¸‹è½½å›¾æ ‡çš„åŠŸèƒ½', 'info');
        };
    </script>
</body>
</html>
